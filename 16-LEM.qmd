# LEMによる連関モデル {-}

本付録では、連関モデルの推定に広く使われてきたソフトウェア LEM（Log-linear and Event history analysis with Missing data）について説明する。

## LEMの概要

LEMは、オランダ・ティルブルフ大学の Jeroen K. Vermunt 氏が開発した、カテゴリカルデータ分析のための専用ソフトウェアである。

### 特徴

| 項目 | 内容 |
|------|------|
| **開発者** | Jeroen K. Vermunt（ティルブルフ大学） |
| **対象** | 対数線形モデル、連関モデル、潜在クラスモデル等 |
| **利点** | gnmでは推定できないモデルも対応可能 |
| **制限** | Windows専用（macOSはWine経由） |

### gnmとの比較

| 機能 | gnm | LEM |
|------|-----|-----|
| 対数線形モデル | ○ | ○ |
| 連関モデル（RC, Unidiff等） | ○ | ○ |
| 複雑な制約（spe構文） | △ | ○ |
| 潜在クラスモデル | × | ○ |
| R統合 | ○ | × |
| GUI | × | × |

gnmで推定できないモデルや、結果の検証にLEMは有用である。


## インストールと実行方法

### Windowsの場合

1. [Vermunt氏のページ](https://jeroenvermunt.nl/)からLEMをダウンロード
2. 適当なフォルダに展開
3. コマンドプロンプトまたは入力ファイルのダブルクリックで実行

### macOSの場合（Wine経由）

macOSではWineを使用してLEMを実行する。

#### Wineのインストール

```bash
# Homebrewを使用
brew install --cask wine-stable
```

#### LEMの実行

```bash
wine LEM95.EXE input.INP output.out
```

::: {.callout-warning}
## 入力ファイルの改行コード

LEMの入力ファイルはCRLF改行（Windows形式）が必要である。LF改行（Unix/macOS形式）だと「No data specified」エラーになる。

```bash
# LF → CRLF に変換
sed -i '' $'s/$/\r/' filename.INP
```
:::


## 基本的な構文

LEMの入力ファイルは以下の構造を持つ。

### 最小構成

```
man <マニフェスト変数の数>
dim <各変数のカテゴリ数>
lab <変数ラベル>
mod <モデル式>
dat <データ>
```

### 変数の定義

```
man 3                    # 3つの観測変数
dim 5 5 3               # 5×5×3のクロス表
lab O D C               # Origin, Destination, Country
```

### モデル式

```
mod {O D C OC DC OD}    # 主効果と2元交互作用
```

### spe構文（特殊制約）

`spe()`関数は、gnmの`Mult()`に相当する乗法的効果を定義する。

```
spe(BC, 5a, A, c, 2)
```

| 引数 | 意味 |
|------|------|
| BC | 対象となる変数の組（B×C） |
| 5a | 5次元スコア（full interaction） |
| A | 層別変数 |
| c | スコアの制約（c=固定） |
| 2 | 識別用のパラメータ番号 |

### des構文（デザイン行列）

```
des [0 1 2]             # 層のスケーリング値
```


## 例：Unidiffモデル（Xie 1992）

@xie1992 のFI_xモデル（3カ国の職業移動表）をLEMで推定する。

### データ

@yamaguchi1987 のデータ（US, Britain, Japan）を使用。

- 5×5の職業移動表（父職業 × 本人職業）
- 3カ国（US, Britain, Japan）

### 入力ファイル

```
man 3
dim 3 5 5
lab C O D

mod {OC DC spe(OD,5a,C,c,2) spe(OD,1a,C,b)}

des [0 1 2]

dat [
1275 364 274 272 17
1055 597 394 443 31
1043 587 1045 951 47
1159 791 1323 2046 52
666 496 1031 1632 646

474 129 87 124 11
300 218 171 220 8
438 254 669 703 16
601 388 932 1789 37
76 56 125 295 191

127 101 24 30 12
86 207 64 61 13
43 73 122 60 13
35 51 62 66 11
109 206 184 253 325
]
```

### モデル式の解説

```
mod {OC DC spe(OD,5a,C,c,2) spe(OD,1a,C,b)}
```

| 項 | 意味 |
|----|------|
| OC | 父職業×国の交互作用 |
| DC | 本人職業×国の交互作用 |
| spe(OD,5a,C,c,2) | OD間のfull interaction（対角セル飽和） |
| spe(OD,1a,C,b) | Unidiff（乗法的層効果） |

- `5a`: 5次元スコア（25セルのfull interaction）
- `1a`: 1次元スコア（uniform association、Unidiff）
- `c`: スコアを固定
- `b`: スケーリングパラメータ（国ごとに異なる）

### 結果

```
L² = 30.94, df = 20, p = .056
```

スケーリングパラメータ（US=1基準）：

| 国 | β |
|----|-----|
| US | 1.0000 |
| Britain | 1.0398 |
| Japan | 0.7989 |

日本は連関が弱い（職業の流動性が高い）ことを示す。


## gnm・Stanとの結果比較

同じモデルを3つの手法で推定した結果：

| 手法 | US | Britain | Japan | L² |
|------|-----|---------|-------|-----|
| gnm | 1.0000 | 1.0398 | 0.7991 | 30.94 |
| LEM | 1.0000 | 1.0398 | 0.7989 | 30.94 |
| Stan | 1.0000 | 1.0399 | 0.7991 | 31.00 |

3つの手法で結果がほぼ一致することが確認できる。

### gnmでの実装

```{r}
#| eval: false
# gnmによるUnidiffモデル
gnm(Freq ~ O*C + D*C + Diag*C + Mult(Exp(C), O*D),
    family = poisson, data = d_xie)
```


## 実務上の使い分け

| 状況 | 推奨ツール |
|------|-----------|
| Rで完結したい | gnm |
| gnmで推定できないモデル | LEM または Stan |
| 結果の検証 | 複数ツールで比較 |
| ベイズ推定が必要 | Stan |
| 潜在クラスモデル | LEM または Stan |


## 参考文献 {-}

- Vermunt, J. K. (1997). *LEM: A general program for the analysis of categorical data*. Tilburg University.
- [Vermunt氏のウェブサイト](https://jeroenvermunt.nl/)

