<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.47">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>LEMによる連関モデル – 『カテゴリカルデータの連関モデル』</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./13-Crosstabs.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./16-LEM.html">LEMによる連関モデル</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">『カテゴリカルデータの連関モデル』</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">はじめに</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1-Introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">シリーズ編者による内容紹介</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2-Chapter_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">第1章</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3-Chapter_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">第2章</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4-Chapter_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">第3章</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5-Chapter_4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">第4章</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./6-Chapter_5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">第5章</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./7-Chapter_6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">第6章</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./8-degrees_of_freedom.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">自由度</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./9-Note.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">補足のノート</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RとRStudioのインストールと基本的な操作方法</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-Replication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">先行研究の再現</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-Review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">研究の動向</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-Crosstabs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">クロス表</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-LEM.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">LEMによる連関モデル</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#lemの概要" id="toc-lemの概要" class="nav-link active" data-scroll-target="#lemの概要">LEMの概要</a>
  <ul class="collapse">
  <li><a href="#特徴" id="toc-特徴" class="nav-link" data-scroll-target="#特徴">特徴</a></li>
  <li><a href="#gnmとの比較" id="toc-gnmとの比較" class="nav-link" data-scroll-target="#gnmとの比較">gnmとの比較</a></li>
  </ul></li>
  <li><a href="#インストールと実行方法" id="toc-インストールと実行方法" class="nav-link" data-scroll-target="#インストールと実行方法">インストールと実行方法</a>
  <ul class="collapse">
  <li><a href="#windowsの場合" id="toc-windowsの場合" class="nav-link" data-scroll-target="#windowsの場合">Windowsの場合</a></li>
  <li><a href="#macosの場合wine経由" id="toc-macosの場合wine経由" class="nav-link" data-scroll-target="#macosの場合wine経由">macOSの場合（Wine経由）</a></li>
  </ul></li>
  <li><a href="#基本的な構文" id="toc-基本的な構文" class="nav-link" data-scroll-target="#基本的な構文">基本的な構文</a>
  <ul class="collapse">
  <li><a href="#最小構成" id="toc-最小構成" class="nav-link" data-scroll-target="#最小構成">最小構成</a></li>
  <li><a href="#変数の定義" id="toc-変数の定義" class="nav-link" data-scroll-target="#変数の定義">変数の定義</a></li>
  <li><a href="#モデル式" id="toc-モデル式" class="nav-link" data-scroll-target="#モデル式">モデル式</a></li>
  <li><a href="#spe構文特殊制約" id="toc-spe構文特殊制約" class="nav-link" data-scroll-target="#spe構文特殊制約">spe構文（特殊制約）</a></li>
  <li><a href="#des構文デザイン行列" id="toc-des構文デザイン行列" class="nav-link" data-scroll-target="#des構文デザイン行列">des構文（デザイン行列）</a></li>
  </ul></li>
  <li><a href="#例-unidiffモデルxie-1992" id="toc-例-unidiffモデルxie-1992" class="nav-link" data-scroll-target="#例-unidiffモデルxie-1992">例 Unidiffモデル（Xie 1992）</a>
  <ul class="collapse">
  <li><a href="#データ" id="toc-データ" class="nav-link" data-scroll-target="#データ">データ</a></li>
  <li><a href="#入力ファイル" id="toc-入力ファイル" class="nav-link" data-scroll-target="#入力ファイル">入力ファイル</a></li>
  <li><a href="#モデル式の解説" id="toc-モデル式の解説" class="nav-link" data-scroll-target="#モデル式の解説">モデル式の解説</a></li>
  <li><a href="#結果" id="toc-結果" class="nav-link" data-scroll-target="#結果">結果</a></li>
  </ul></li>
  <li><a href="#gnmstanとの結果比較" id="toc-gnmstanとの結果比較" class="nav-link" data-scroll-target="#gnmstanとの結果比較">gnm・Stanとの結果比較</a>
  <ul class="collapse">
  <li><a href="#データの準備r" id="toc-データの準備r" class="nav-link" data-scroll-target="#データの準備r">データの準備（R）</a></li>
  <li><a href="#gnmによる推定" id="toc-gnmによる推定" class="nav-link" data-scroll-target="#gnmによる推定">gnmによる推定</a></li>
  <li><a href="#stanによる推定" id="toc-stanによる推定" class="nav-link" data-scroll-target="#stanによる推定">Stanによる推定</a></li>
  <li><a href="#結果の比較" id="toc-結果の比較" class="nav-link" data-scroll-target="#結果の比較">結果の比較</a></li>
  </ul></li>
  <li><a href="#rからlemを繰り返し実行する" id="toc-rからlemを繰り返し実行する" class="nav-link" data-scroll-target="#rからlemを繰り返し実行する">RからLEMを繰り返し実行する</a>
  <ul class="collapse">
  <li><a href="#複数モデルの一括実行" id="toc-複数モデルの一括実行" class="nav-link" data-scroll-target="#複数モデルの一括実行">複数モデルの一括実行</a></li>
  </ul></li>
  <li><a href="#実務上の使い分け" id="toc-実務上の使い分け" class="nav-link" data-scroll-target="#実務上の使い分け">実務上の使い分け</a></li>
  <li><a href="#参考文献" id="toc-参考文献" class="nav-link" data-scroll-target="#参考文献">参考文献</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">LEMによる連関モデル</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>本付録では、連関モデルの推定に広く使われてきたソフトウェア LEM（Log-linear and Event history analysis with Missing data）について説明する。</p>
<section id="lemの概要" class="level2">
<h2 class="anchored" data-anchor-id="lemの概要">LEMの概要</h2>
<p>LEMは、オランダ・ティルブルフ大学の Jeroen K. Vermunt 氏が開発した、カテゴリカルデータ分析のための専用ソフトウェアである。</p>
<section id="特徴" class="level3">
<h3 class="anchored" data-anchor-id="特徴">特徴</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>開発者</strong></td>
<td>Jeroen K. Vermunt（ティルブルフ大学）</td>
</tr>
<tr class="even">
<td><strong>対象</strong></td>
<td>対数線形モデル、連関モデル、潜在クラスモデル等</td>
</tr>
<tr class="odd">
<td><strong>利点</strong></td>
<td>gnmでは推定できないモデルも対応可能</td>
</tr>
<tr class="even">
<td><strong>制限</strong></td>
<td>Windows専用（macOSはWine経由）</td>
</tr>
</tbody>
</table>
</section>
<section id="gnmとの比較" class="level3">
<h3 class="anchored" data-anchor-id="gnmとの比較">gnmとの比較</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>機能</th>
<th>gnm</th>
<th>LEM</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>対数線形モデル</td>
<td>○</td>
<td>○</td>
</tr>
<tr class="even">
<td>連関モデル（RC, Unidiff等）</td>
<td>○</td>
<td>○</td>
</tr>
<tr class="odd">
<td>複雑な制約（spe構文）</td>
<td>△</td>
<td>○</td>
</tr>
<tr class="even">
<td>潜在クラスモデル</td>
<td>×</td>
<td>○</td>
</tr>
<tr class="odd">
<td>R統合</td>
<td>○</td>
<td>×</td>
</tr>
<tr class="even">
<td>GUI</td>
<td>×</td>
<td>×</td>
</tr>
</tbody>
</table>
<p>gnmで推定できないモデルや、結果の検証にLEMは有用である。</p>
</section>
</section>
<section id="インストールと実行方法" class="level2">
<h2 class="anchored" data-anchor-id="インストールと実行方法">インストールと実行方法</h2>
<section id="windowsの場合" class="level3">
<h3 class="anchored" data-anchor-id="windowsの場合">Windowsの場合</h3>
<ol type="1">
<li><a href="https://jeroenvermunt.nl/">Vermunt氏のページ</a>からLEMをダウンロード</li>
<li>適当なフォルダに展開</li>
<li>コマンドプロンプトまたは入力ファイルのダブルクリックで実行</li>
</ol>
</section>
<section id="macosの場合wine経由" class="level3">
<h3 class="anchored" data-anchor-id="macosの場合wine経由">macOSの場合（Wine経由）</h3>
<p>macOSではWineを使用してLEMを実行する。</p>
<section id="wineのインストール" class="level4">
<h4 class="anchored" data-anchor-id="wineのインストール">Wineのインストール</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Homebrewを使用</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install <span class="at">--cask</span> wine-stable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="lemの実行" class="level4">
<h4 class="anchored" data-anchor-id="lemの実行">LEMの実行</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">wine</span> LEM95.EXE input.INP output.out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
入力ファイルの改行コード
</div>
</div>
<div class="callout-body-container callout-body">
<p>LEMの入力ファイルはCRLF改行（Windows形式）が必要である。LF改行（Unix/macOS形式）だと「No data specified」エラーになる。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># LF → CRLF に変換</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">''</span> <span class="st">$'s/$/</span><span class="dt">\r</span><span class="st">/'</span> filename.INP</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
</section>
</section>
<section id="基本的な構文" class="level2">
<h2 class="anchored" data-anchor-id="基本的な構文">基本的な構文</h2>
<p>LEMの入力ファイルは以下の構造を持つ。</p>
<section id="最小構成" class="level3">
<h3 class="anchored" data-anchor-id="最小構成">最小構成</h3>
<pre><code>man &lt;マニフェスト変数の数&gt;
dim &lt;各変数のカテゴリ数&gt;
lab &lt;変数ラベル&gt;
mod &lt;モデル式&gt;
dat &lt;データ&gt;</code></pre>
</section>
<section id="変数の定義" class="level3">
<h3 class="anchored" data-anchor-id="変数の定義">変数の定義</h3>
<pre><code>man 3                    # 3つの観測変数
dim 5 5 3               # 5×5×3のクロス表
lab O D C               # Origin, Destination, Country</code></pre>
</section>
<section id="モデル式" class="level3">
<h3 class="anchored" data-anchor-id="モデル式">モデル式</h3>
<pre><code>mod {O D C OC DC OD}    # 主効果と2元交互作用</code></pre>
</section>
<section id="spe構文特殊制約" class="level3">
<h3 class="anchored" data-anchor-id="spe構文特殊制約">spe構文（特殊制約）</h3>
<p><code>spe()</code>関数は、gnmの<code>Mult()</code>に相当する乗法的効果を定義する。</p>
<pre><code>spe(BC, 5a, A, c, 2)</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>引数</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>BC</td>
<td>対象となる変数の組（B×C）</td>
</tr>
<tr class="even">
<td>5a</td>
<td>5次元スコア（full interaction）</td>
</tr>
<tr class="odd">
<td>A</td>
<td>層別変数</td>
</tr>
<tr class="even">
<td>c</td>
<td>スコアの制約（c=固定）</td>
</tr>
<tr class="odd">
<td>2</td>
<td>識別用のパラメータ番号</td>
</tr>
</tbody>
</table>
</section>
<section id="des構文デザイン行列" class="level3">
<h3 class="anchored" data-anchor-id="des構文デザイン行列">des構文（デザイン行列）</h3>
<pre><code>des [0 1 2]             # 層のスケーリング値</code></pre>
</section>
</section>
<section id="例-unidiffモデルxie-1992" class="level2">
<h2 class="anchored" data-anchor-id="例-unidiffモデルxie-1992">例 Unidiffモデル（Xie 1992）</h2>
<p><span class="citation" data-cites="xie1992">Xie (<a href="#ref-xie1992" role="doc-biblioref">1992</a>)</span> のFI_xモデル（3カ国の職業移動表）をLEMで推定する。</p>
<section id="データ" class="level3">
<h3 class="anchored" data-anchor-id="データ">データ</h3>
<p><span class="citation" data-cites="yamaguchi1987">Yamaguchi (<a href="#ref-yamaguchi1987" role="doc-biblioref">1987</a>)</span> のデータ（US, Britain, Japan）を使用。</p>
<ul>
<li>5×5の職業移動表（父職業 × 本人職業）</li>
<li>3カ国（US, Britain, Japan）</li>
</ul>
</section>
<section id="入力ファイル" class="level3">
<h3 class="anchored" data-anchor-id="入力ファイル">入力ファイル</h3>
<pre><code>man 3
dim 3 5 5
lab C O D

mod {OC DC spe(OD,5a,C,c,2) spe(OD,1a,C,b)}

des [0 1 2]

dat [
1275 364 274 272 17
1055 597 394 443 31
1043 587 1045 951 47
1159 791 1323 2046 52
666 496 1031 1632 646

474 129 87 124 11
300 218 171 220 8
438 254 669 703 16
601 388 932 1789 37
76 56 125 295 191

127 101 24 30 12
86 207 64 61 13
43 73 122 60 13
35 51 62 66 11
109 206 184 253 325
]</code></pre>
</section>
<section id="モデル式の解説" class="level3">
<h3 class="anchored" data-anchor-id="モデル式の解説">モデル式の解説</h3>
<pre><code>mod {OC DC spe(OD,5a,C,c,2) spe(OD,1a,C,b)}</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>項</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>OC</td>
<td>父職業×国の交互作用</td>
</tr>
<tr class="even">
<td>DC</td>
<td>本人職業×国の交互作用</td>
</tr>
<tr class="odd">
<td>spe(OD,5a,C,c,2)</td>
<td>OD間のfull interaction（対角セル飽和）</td>
</tr>
<tr class="even">
<td>spe(OD,1a,C,b)</td>
<td>Unidiff（乗法的層効果）</td>
</tr>
</tbody>
</table>
<ul>
<li><code>5a</code>: 5次元スコア（25セルのfull interaction）</li>
<li><code>1a</code>: 1次元スコア（uniform association、Unidiff）</li>
<li><code>c</code>: スコアを固定</li>
<li><code>b</code>: スケーリングパラメータ（国ごとに異なる）</li>
</ul>
</section>
<section id="結果" class="level3">
<h3 class="anchored" data-anchor-id="結果">結果</h3>
<pre><code>L² = 30.94, df = 20, p = .056</code></pre>
<p>スケーリングパラメータ（US=1基準）</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>国</th>
<th>β</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>US</td>
<td>1.0000</td>
</tr>
<tr class="even">
<td>Britain</td>
<td>1.0398</td>
</tr>
<tr class="odd">
<td>Japan</td>
<td>0.7989</td>
</tr>
</tbody>
</table>
<p>日本は連関が弱い（職業の流動性が高い）ことを示す。</p>
</section>
</section>
<section id="gnmstanとの結果比較" class="level2">
<h2 class="anchored" data-anchor-id="gnmstanとの結果比較">gnm・Stanとの結果比較</h2>
<p>同じUnidiffモデルをgnmとStanでも推定し、LEMの結果と比較する。</p>
<section id="データの準備r" class="level3">
<h3 class="anchored" data-anchor-id="データの準備r">データの準備（R）</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gnm)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>Freq_yamaguchi <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1275</span>, <span class="dv">364</span>, <span class="dv">274</span>, <span class="dv">272</span>, <span class="dv">17</span>, <span class="dv">1055</span>, <span class="dv">597</span>, <span class="dv">394</span>, <span class="dv">443</span>, <span class="dv">31</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1043</span>, <span class="dv">587</span>, <span class="dv">1045</span>, <span class="dv">951</span>, <span class="dv">47</span>, <span class="dv">1159</span>, <span class="dv">791</span>, <span class="dv">1323</span>, <span class="dv">2046</span>, <span class="dv">52</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="dv">666</span>, <span class="dv">496</span>, <span class="dv">1031</span>, <span class="dv">1632</span>, <span class="dv">646</span>, <span class="dv">474</span>, <span class="dv">129</span>, <span class="dv">87</span>, <span class="dv">124</span>, <span class="dv">11</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="dv">300</span>, <span class="dv">218</span>, <span class="dv">171</span>, <span class="dv">220</span>, <span class="dv">8</span>, <span class="dv">438</span>, <span class="dv">254</span>, <span class="dv">669</span>, <span class="dv">703</span>, <span class="dv">16</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="dv">601</span>, <span class="dv">388</span>, <span class="dv">932</span>, <span class="dv">1789</span>, <span class="dv">37</span>, <span class="dv">76</span>, <span class="dv">56</span>, <span class="dv">125</span>, <span class="dv">295</span>, <span class="dv">191</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="dv">127</span>, <span class="dv">101</span>, <span class="dv">24</span>, <span class="dv">30</span>, <span class="dv">12</span>, <span class="dv">86</span>, <span class="dv">207</span>, <span class="dv">64</span>, <span class="dv">61</span>, <span class="dv">13</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="dv">43</span>, <span class="dv">73</span>, <span class="dv">122</span>, <span class="dv">60</span>, <span class="dv">13</span>, <span class="dv">35</span>, <span class="dv">51</span>, <span class="dv">62</span>, <span class="dv">66</span>, <span class="dv">11</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="dv">109</span>, <span class="dv">206</span>, <span class="dv">184</span>, <span class="dv">253</span>, <span class="dv">325</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>d_xie <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">O =</span> <span class="fu">gl</span>(<span class="dv">5</span>, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">length =</span> <span class="dv">75</span>),</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> <span class="fu">gl</span>(<span class="dv">5</span>, <span class="at">k =</span> <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">75</span>),</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">C =</span> <span class="fu">gl</span>(<span class="dv">3</span>, <span class="at">k =</span> <span class="dv">25</span>, <span class="at">length =</span> <span class="dv">75</span>),</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">Freq =</span> Freq_yamaguchi</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">Diag =</span> <span class="fu">case_when</span>(O <span class="sc">==</span> D <span class="sc">~</span> O, <span class="at">.default =</span> <span class="st">"0"</span>) <span class="sc">|&gt;</span> <span class="fu">factor</span>()</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gnmによる推定" class="level3">
<h3 class="anchored" data-anchor-id="gnmによる推定">gnmによる推定</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>fit_gnm <span class="ot">&lt;-</span> <span class="fu">gnm</span>(Freq <span class="sc">~</span> O<span class="sc">*</span>C <span class="sc">+</span> D<span class="sc">*</span>C <span class="sc">+</span> Diag<span class="sc">*</span>C <span class="sc">+</span> <span class="fu">Mult</span>(<span class="fu">Exp</span>(C), O<span class="sc">*</span>D),</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">family =</span> poisson, <span class="at">data =</span> d_xie, <span class="at">tolerance =</span> <span class="fl">1e-12</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># スケーリングパラメータの取り出し</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>coef_gnm <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_gnm)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>exp_c_coefs <span class="ot">&lt;-</span> coef_gnm[<span class="fu">grep</span>(<span class="st">"^Mult.*Exp.*</span><span class="sc">\\</span><span class="st">.C"</span>, <span class="fu">names</span>(coef_gnm))]</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>gnm_beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(exp_c_coefs <span class="sc">-</span> exp_c_coefs[<span class="dv">1</span>])</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(gnm_beta) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"US"</span>, <span class="st">"Britain"</span>, <span class="st">"Japan"</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>gnm_beta</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       US  Britain    Japan</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   1.0000   1.0398   0.7991</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>Mult(Exp(C), O*D)</code> がUnidiff項であり、<code>Diag*C</code> は対角セルの飽和を表す。</p>
</section>
<section id="stanによる推定" class="level3">
<h3 class="anchored" data-anchor-id="stanによる推定">Stanによる推定</h3>
<p>対角セルを完全飽和（<code>alpha_diag</code>、15セル）させ、非対角セルにのみUnidiff構造（<code>beta[k] * psi[ij]</code>）を適用する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>stan_code <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N; int&lt;lower=1&gt; I; int&lt;lower=1&gt; J; int&lt;lower=1&gt; K;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; IJ; int&lt;lower=1&gt; N_diag;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1&gt; row_idx; array[N] int&lt;lower=1&gt; col_idx;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1&gt; layer_idx; array[N] int&lt;lower=1&gt; cell_idx;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0, upper=N_diag&gt; diag_cell_idx;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0&gt; y;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha;</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[I-1] alpha_row_raw; vector[J-1] alpha_col_raw;</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K-1] alpha_layer_raw;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I-1, K-1] alpha_row_layer_raw;</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[J-1, K-1] alpha_col_layer_raw;</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_diag-1] alpha_diag_raw;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[IJ-1] psi_raw;</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K-1] beta_raw;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[I] alpha_row; vector[J] alpha_col; vector[K] alpha_layer;</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I, K] alpha_row_layer; matrix[J, K] alpha_col_layer;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_diag] alpha_diag; vector[IJ] psi; vector[K] beta;</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] log_mu;</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="st">  // コーナー制約</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha_row[1]=0; alpha_col[1]=0; alpha_layer[1]=0;</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 2:I) alpha_row[i] = alpha_row_raw[i-1];</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="st">  for(j in 2:J) alpha_col[j] = alpha_col_raw[j-1];</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="st">  for(k in 2:K) alpha_layer[k] = alpha_layer_raw[k-1];</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="st">  // 交互作用</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="st">  for(k in 1:K) { alpha_row_layer[1,k]=0; alpha_col_layer[1,k]=0; }</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:I) alpha_row_layer[i,1] = 0;</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="st">  for(j in 1:J) alpha_col_layer[j,1] = 0;</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 2:I) for(k in 2:K)</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha_row_layer[i,k] = alpha_row_layer_raw[i-1,k-1];</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="st">  for(j in 2:J) for(k in 2:K)</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha_col_layer[j,k] = alpha_col_layer_raw[j-1,k-1];</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="st">  // 対角セルの完全飽和（15セル, 14自由パラメータ）</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha_diag[1] = 0;</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="st">  for(d in 2:N_diag) alpha_diag[d] = alpha_diag_raw[d-1];</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="st">  // OD連関パターン</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a><span class="st">  psi[1] = 0;</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a><span class="st">  for(ij in 2:IJ) psi[ij] = psi_raw[ij-1];</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a><span class="st">  // Unidiffスケーリング（beta[1]=1に固定）</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a><span class="st">  beta[1] = 1;</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a><span class="st">  for(k in 2:K) beta[k] = exp(beta_raw[k-1]);</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a><span class="st">  // 期待度数</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a><span class="st">  for(n in 1:N) {</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a><span class="st">    log_mu[n] = alpha + alpha_row[row_idx[n]] + alpha_col[col_idx[n]]</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a><span class="st">                + alpha_layer[layer_idx[n]]</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a><span class="st">                + alpha_row_layer[row_idx[n], layer_idx[n]]</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a><span class="st">                + alpha_col_layer[col_idx[n], layer_idx[n]];</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a><span class="st">    if(diag_cell_idx[n] &gt; 0)</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a><span class="st">      log_mu[n] += alpha_diag[diag_cell_idx[n]];</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a><span class="st">      log_mu[n] += beta[layer_idx[n]] * psi[cell_idx[n]];</span></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a><span class="st">  y ~ poisson_log(log_mu);</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] expected;</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a><span class="st">  for(n in 1:N) expected[n] = exp(log_mu[n]);</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a><span class="co"># データの準備</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>d_xie_stan <span class="ot">&lt;-</span> d_xie <span class="sc">|&gt;</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">i_O =</span> <span class="fu">as.integer</span>(O), <span class="at">i_D =</span> <span class="fu">as.integer</span>(D), <span class="at">i_C =</span> <span class="fu">as.integer</span>(C),</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">cell_OD =</span> (i_O <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">5</span> <span class="sc">+</span> i_D,</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">diag_cell_idx =</span> <span class="fu">if_else</span>(O <span class="sc">==</span> D, (i_C <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">5</span> <span class="sc">+</span> <span class="fu">as.integer</span>(O), <span class="dv">0</span>L)</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="dv">75</span>, <span class="at">I =</span> <span class="dv">5</span>, <span class="at">J =</span> <span class="dv">5</span>, <span class="at">K =</span> <span class="dv">3</span>, <span class="at">IJ =</span> <span class="dv">25</span>, <span class="at">N_diag =</span> <span class="dv">15</span>,</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_idx =</span> d_xie_stan<span class="sc">$</span>i_O, <span class="at">col_idx =</span> d_xie_stan<span class="sc">$</span>i_D,</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">layer_idx =</span> d_xie_stan<span class="sc">$</span>i_C, <span class="at">cell_idx =</span> d_xie_stan<span class="sc">$</span>cell_OD,</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">diag_cell_idx =</span> d_xie_stan<span class="sc">$</span>diag_cell_idx, <span class="at">y =</span> d_xie_stan<span class="sc">$</span>Freq</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a><span class="co"># MLE推定</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="fu">write_stan_file</span>(stan_code))</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>fit_mle <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">optimize</span>(<span class="at">data =</span> stan_data, <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>                          <span class="at">algorithm =</span> <span class="st">"lbfgs"</span>,</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>                          <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">tol_rel_grad =</span> <span class="fl">1e-12</span>)</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a><span class="co"># スケーリングパラメータ</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>mle_summary <span class="ot">&lt;-</span> fit_mle<span class="sc">$</span><span class="fu">summary</span>()</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>beta_stan <span class="ot">&lt;-</span> mle_summary <span class="sc">|&gt;</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"^beta</span><span class="sc">\\</span><span class="st">["</span>, variable)) <span class="sc">|&gt;</span> <span class="fu">pull</span>(estimate)</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; US=1.0000, Britain=1.0399, Japan=0.7991</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="結果の比較" class="level3">
<h3 class="anchored" data-anchor-id="結果の比較">結果の比較</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>手法</th>
<th>US</th>
<th>Britain</th>
<th>Japan</th>
<th>L²</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>gnm</td>
<td>1.0000</td>
<td>1.0398</td>
<td>0.7991</td>
<td>30.94</td>
</tr>
<tr class="even">
<td>LEM</td>
<td>1.0000</td>
<td>1.0398</td>
<td>0.7989</td>
<td>30.94</td>
</tr>
<tr class="odd">
<td>Stan (MLE)</td>
<td>1.0000</td>
<td>1.0399</td>
<td>0.7991</td>
<td>31.00</td>
</tr>
</tbody>
</table>
<p>3つの手法で結果がほぼ一致する。期待度数の相関は r = 1.0000 である。</p>
</section>
</section>
<section id="rからlemを繰り返し実行する" class="level2">
<h2 class="anchored" data-anchor-id="rからlemを繰り返し実行する">RからLEMを繰り返し実行する</h2>
<p>macOSではWineの実行完了後に「Close the log window?」というダイアログが表示され、手動で閉じるまでプロセスが終了しない。以下の関数は、LEMをバックグラウンドで起動し、出力ファイルの完成を待ってWineプロセスを自動終了させる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>run_lem <span class="ot">&lt;-</span> <span class="cf">function</span>(inp_path, out_path, lem_exe, <span class="at">label =</span> <span class="st">""</span>) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(out_path)) <span class="fu">file.remove</span>(out_path)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">Sys.info</span>()[<span class="st">"sysname"</span>] <span class="sc">==</span> <span class="st">"Windows"</span>) {</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(<span class="fu">paste</span>(<span class="fu">shQuote</span>(lem_exe), <span class="fu">shQuote</span>(inp_path), <span class="fu">shQuote</span>(out_path)))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    cmd <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"wine"</span>, <span class="fu">shQuote</span>(lem_exe), <span class="fu">shQuote</span>(inp_path), <span class="fu">shQuote</span>(out_path))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(<span class="fu">paste</span>(cmd, <span class="st">"2&gt;/dev/null &amp;"</span>))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">600</span>) {</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="dv">1</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(out_path) <span class="sc">&amp;&amp;</span> <span class="fu">file.size</span>(out_path) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        old_size <span class="ot">&lt;-</span> <span class="fu">file.size</span>(out_path)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Sys.sleep</span>(<span class="dv">2</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">file.size</span>(out_path) <span class="sc">==</span> old_size) <span class="cf">break</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(<span class="st">"wineserver -k 2&gt;/dev/null"</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="dv">1</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(out_path) <span class="sc">&amp;&amp;</span> <span class="fu">file.size</span>(out_path) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(label, <span class="st">" completed: "</span>, out_path)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(label, <span class="st">" may have failed"</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>仕組みは以下の通りである。</p>
<ol type="1">
<li><code>&amp;</code> によりWineをバックグラウンドで起動する。<code>shQuote()</code> でパスの空白に対応している。</li>
<li>出力ファイルのサイズを1秒ごとに確認し、2秒間変化しなければ書き込み完了と判断する。</li>
<li><code>wineserver -k</code> でWineプロセスを一括終了し、ダイアログを自動的に閉じる。他のWineアプリケーションも終了するため注意が必要である。</li>
</ol>
<section id="複数モデルの一括実行" class="level3">
<h3 class="anchored" data-anchor-id="複数モデルの一括実行">複数モデルの一括実行</h3>
<p>モデル式をリストとして定義し、ループで一時的な <code>.inp</code> ファイルを生成して実行する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>lem_exe <span class="ot">&lt;-</span> <span class="st">"path/to/LEM95.EXE"</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>lem_dir <span class="ot">&lt;-</span> <span class="st">"path/to/lem_directory"</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">M1 =</span> <span class="st">"mod {AB AC}"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">M2 =</span> <span class="st">"mod {AB AC BC}"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">M3 =</span> <span class="st">"mod {AB AC spe(BC,1a,A,b)}"</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>header <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"man 3"</span>, <span class="st">"dim 3 5 5"</span>, <span class="st">"lab A B C"</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>footer <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"des [0 1 2]"</span>, <span class="st">"dat mydata.dat"</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name <span class="cf">in</span> <span class="fu">names</span>(models)) {</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  inp_lines <span class="ot">&lt;-</span> <span class="fu">c</span>(header, models[[name]], footer)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  inp_path  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(lem_dir, <span class="fu">paste0</span>(<span class="st">"temp_"</span>, name, <span class="st">".inp"</span>))</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  out_path  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(lem_dir, <span class="fu">paste0</span>(name, <span class="st">".out"</span>))</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(inp_lines, inp_path)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">run_lem</span>(inp_path, out_path, lem_exe, <span class="at">label =</span> name)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.remove</span>(inp_path)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="実務上の使い分け" class="level2">
<h2 class="anchored" data-anchor-id="実務上の使い分け">実務上の使い分け</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>状況</th>
<th>推奨ツール</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Rで完結したい</td>
<td>gnm</td>
</tr>
<tr class="even">
<td>gnmで推定できないモデル</td>
<td>LEM または Stan</td>
</tr>
<tr class="odd">
<td>結果の検証</td>
<td>複数ツールで比較</td>
</tr>
<tr class="even">
<td>ベイズ推定が必要</td>
<td>Stan</td>
</tr>
<tr class="odd">
<td>潜在クラスモデル</td>
<td>LEM または Stan</td>
</tr>
</tbody>
</table>
</section>
<section id="参考文献" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="参考文献">参考文献</h2>
<ul>
<li>Vermunt, J. K. (1997). <em>LEM: A general program for the analysis of categorical data</em>. Tilburg University.</li>
<li><a href="https://jeroenvermunt.nl/">Vermunt氏のウェブサイト</a></li>
</ul>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-xie1992" class="csl-entry" role="listitem">
Xie, Yu. 1992. <span>“The <span>Log-Multiplicative Layer Effect Model</span> for <span>Comparing Mobility Tables</span>.”</span> <em>American Sociological Review</em> 57 (3): 380–95. <a href="https://doi.org/10.2307/2096242">https://doi.org/10.2307/2096242</a>.
</div>
<div id="ref-yamaguchi1987" class="csl-entry" role="listitem">
Yamaguchi, Kazuo. 1987. <span>“Models for <span>Comparing Mobility Tables</span>: <span>Toward Parsimony</span> and <span>Substance</span>.”</span> <em>American Sociological Review</em> 52 (4): 482–94. <a href="https://doi.org/10.2307/2095293">https://doi.org/10.2307/2095293</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./13-Crosstabs.html" class="pagination-link" aria-label="クロス表">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">クロス表</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb17" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># LEMによる連関モデル {-}</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>本付録では、連関モデルの推定に広く使われてきたソフトウェア LEM（Log-linear and Event history analysis with Missing data）について説明する。</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">## LEMの概要</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>LEMは、オランダ・ティルブルフ大学の Jeroen K. Vermunt 氏が開発した、カテゴリカルデータ分析のための専用ソフトウェアである。</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">### 特徴</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>| 項目 | 内容 |</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>|------|------|</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>| **開発者** | Jeroen K. Vermunt（ティルブルフ大学） |</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>| **対象** | 対数線形モデル、連関モデル、潜在クラスモデル等 |</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>| **利点** | gnmでは推定できないモデルも対応可能 |</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>| **制限** | Windows専用（macOSはWine経由） |</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="fu">### gnmとの比較</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>| 機能 | gnm | LEM |</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>|------|-----|-----|</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>| 対数線形モデル | ○ | ○ |</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>| 連関モデル（RC, Unidiff等） | ○ | ○ |</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>| 複雑な制約（spe構文） | △ | ○ |</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>| 潜在クラスモデル | × | ○ |</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>| R統合 | ○ | × |</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>| GUI | × | × |</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>gnmで推定できないモデルや、結果の検証にLEMは有用である。</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="fu">## インストールと実行方法</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="fu">### Windowsの場合</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="co">[</span><span class="ot">Vermunt氏のページ</span><span class="co">](https://jeroenvermunt.nl/)</span>からLEMをダウンロード</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>適当なフォルダに展開</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>コマンドプロンプトまたは入力ファイルのダブルクリックで実行</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="fu">### macOSの場合（Wine経由）</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>macOSではWineを使用してLEMを実行する。</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Wineのインストール</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Homebrewを使用</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install <span class="at">--cask</span> wine-stable</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a><span class="fu">#### LEMの実行</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a><span class="ex">wine</span> LEM95.EXE input.INP output.out</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a><span class="fu">## 入力ファイルの改行コード</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>LEMの入力ファイルはCRLF改行（Windows形式）が必要である。LF改行（Unix/macOS形式）だと「No data specified」エラーになる。</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a><span class="co"># LF → CRLF に変換</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">''</span> <span class="st">$'s/$/</span><span class="dt">\r</span><span class="st">/'</span> filename.INP</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a><span class="fu">## 基本的な構文</span></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>LEMの入力ファイルは以下の構造を持つ。</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a><span class="fu">### 最小構成</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a><span class="in">man &lt;マニフェスト変数の数&gt;</span></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a><span class="in">dim &lt;各変数のカテゴリ数&gt;</span></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a><span class="in">lab &lt;変数ラベル&gt;</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a><span class="in">mod &lt;モデル式&gt;</span></span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a><span class="in">dat &lt;データ&gt;</span></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a><span class="fu">### 変数の定義</span></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a><span class="in">man 3                    # 3つの観測変数</span></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a><span class="in">dim 5 5 3               # 5×5×3のクロス表</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a><span class="in">lab O D C               # Origin, Destination, Country</span></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a><span class="fu">### モデル式</span></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a><span class="in">mod {O D C OC DC OD}    # 主効果と2元交互作用</span></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a><span class="fu">### spe構文（特殊制約）</span></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a><span class="in">`spe()`</span>関数は、gnmの<span class="in">`Mult()`</span>に相当する乗法的効果を定義する。</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a><span class="in">spe(BC, 5a, A, c, 2)</span></span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>| 引数 | 意味 |</span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>|------|------|</span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a>| BC | 対象となる変数の組（B×C） |</span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a>| 5a | 5次元スコア（full interaction） |</span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>| A | 層別変数 |</span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a>| c | スコアの制約（c=固定） |</span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>| 2 | 識別用のパラメータ番号 |</span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a><span class="fu">### des構文（デザイン行列）</span></span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a><span class="in">des [0 1 2]             # 層のスケーリング値</span></span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a><span class="fu">## 例 Unidiffモデル（Xie 1992）</span></span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>@xie1992 のFI_xモデル（3カ国の職業移動表）をLEMで推定する。</span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a><span class="fu">### データ</span></span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a>@yamaguchi1987 のデータ（US, Britain, Japan）を使用。</span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>5×5の職業移動表（父職業 × 本人職業）</span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>3カ国（US, Britain, Japan）</span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a><span class="fu">### 入力ファイル</span></span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a><span class="in">man 3</span></span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a><span class="in">dim 3 5 5</span></span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a><span class="in">lab C O D</span></span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a><span class="in">mod {OC DC spe(OD,5a,C,c,2) spe(OD,1a,C,b)}</span></span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a><span class="in">des [0 1 2]</span></span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a><span class="in">dat [</span></span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a><span class="in">1275 364 274 272 17</span></span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a><span class="in">1055 597 394 443 31</span></span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a><span class="in">1043 587 1045 951 47</span></span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a><span class="in">1159 791 1323 2046 52</span></span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a><span class="in">666 496 1031 1632 646</span></span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a><span class="in">474 129 87 124 11</span></span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a><span class="in">300 218 171 220 8</span></span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a><span class="in">438 254 669 703 16</span></span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a><span class="in">601 388 932 1789 37</span></span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a><span class="in">76 56 125 295 191</span></span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a><span class="in">127 101 24 30 12</span></span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a><span class="in">86 207 64 61 13</span></span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a><span class="in">43 73 122 60 13</span></span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a><span class="in">35 51 62 66 11</span></span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a><span class="in">109 206 184 253 325</span></span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a><span class="in">]</span></span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a><span class="fu">### モデル式の解説</span></span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-166"><a href="#cb17-166" aria-hidden="true" tabindex="-1"></a><span class="in">mod {OC DC spe(OD,5a,C,c,2) spe(OD,1a,C,b)}</span></span>
<span id="cb17-167"><a href="#cb17-167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a>| 項 | 意味 |</span>
<span id="cb17-170"><a href="#cb17-170" aria-hidden="true" tabindex="-1"></a>|----|------|</span>
<span id="cb17-171"><a href="#cb17-171" aria-hidden="true" tabindex="-1"></a>| OC | 父職業×国の交互作用 |</span>
<span id="cb17-172"><a href="#cb17-172" aria-hidden="true" tabindex="-1"></a>| DC | 本人職業×国の交互作用 |</span>
<span id="cb17-173"><a href="#cb17-173" aria-hidden="true" tabindex="-1"></a>| spe(OD,5a,C,c,2) | OD間のfull interaction（対角セル飽和） |</span>
<span id="cb17-174"><a href="#cb17-174" aria-hidden="true" tabindex="-1"></a>| spe(OD,1a,C,b) | Unidiff（乗法的層効果） |</span>
<span id="cb17-175"><a href="#cb17-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-176"><a href="#cb17-176" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`5a`</span>: 5次元スコア（25セルのfull interaction）</span>
<span id="cb17-177"><a href="#cb17-177" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`1a`</span>: 1次元スコア（uniform association、Unidiff）</span>
<span id="cb17-178"><a href="#cb17-178" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`c`</span>: スコアを固定</span>
<span id="cb17-179"><a href="#cb17-179" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`b`</span>: スケーリングパラメータ（国ごとに異なる）</span>
<span id="cb17-180"><a href="#cb17-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-181"><a href="#cb17-181" aria-hidden="true" tabindex="-1"></a><span class="fu">### 結果</span></span>
<span id="cb17-182"><a href="#cb17-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-183"><a href="#cb17-183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-184"><a href="#cb17-184" aria-hidden="true" tabindex="-1"></a><span class="in">L² = 30.94, df = 20, p = .056</span></span>
<span id="cb17-185"><a href="#cb17-185" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-186"><a href="#cb17-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-187"><a href="#cb17-187" aria-hidden="true" tabindex="-1"></a>スケーリングパラメータ（US=1基準）</span>
<span id="cb17-188"><a href="#cb17-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-189"><a href="#cb17-189" aria-hidden="true" tabindex="-1"></a>| 国 | β |</span>
<span id="cb17-190"><a href="#cb17-190" aria-hidden="true" tabindex="-1"></a>|----|-----|</span>
<span id="cb17-191"><a href="#cb17-191" aria-hidden="true" tabindex="-1"></a>| US | 1.0000 |</span>
<span id="cb17-192"><a href="#cb17-192" aria-hidden="true" tabindex="-1"></a>| Britain | 1.0398 |</span>
<span id="cb17-193"><a href="#cb17-193" aria-hidden="true" tabindex="-1"></a>| Japan | 0.7989 |</span>
<span id="cb17-194"><a href="#cb17-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-195"><a href="#cb17-195" aria-hidden="true" tabindex="-1"></a>日本は連関が弱い（職業の流動性が高い）ことを示す。</span>
<span id="cb17-196"><a href="#cb17-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-197"><a href="#cb17-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-198"><a href="#cb17-198" aria-hidden="true" tabindex="-1"></a><span class="fu">## gnm・Stanとの結果比較</span></span>
<span id="cb17-199"><a href="#cb17-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-200"><a href="#cb17-200" aria-hidden="true" tabindex="-1"></a>同じUnidiffモデルをgnmとStanでも推定し、LEMの結果と比較する。</span>
<span id="cb17-201"><a href="#cb17-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-202"><a href="#cb17-202" aria-hidden="true" tabindex="-1"></a><span class="fu">### データの準備（R）</span></span>
<span id="cb17-203"><a href="#cb17-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-206"><a href="#cb17-206" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-207"><a href="#cb17-207" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb17-208"><a href="#cb17-208" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb17-209"><a href="#cb17-209" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gnm)</span>
<span id="cb17-210"><a href="#cb17-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-211"><a href="#cb17-211" aria-hidden="true" tabindex="-1"></a>Freq_yamaguchi <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb17-212"><a href="#cb17-212" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1275</span>, <span class="dv">364</span>, <span class="dv">274</span>, <span class="dv">272</span>, <span class="dv">17</span>, <span class="dv">1055</span>, <span class="dv">597</span>, <span class="dv">394</span>, <span class="dv">443</span>, <span class="dv">31</span>,</span>
<span id="cb17-213"><a href="#cb17-213" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1043</span>, <span class="dv">587</span>, <span class="dv">1045</span>, <span class="dv">951</span>, <span class="dv">47</span>, <span class="dv">1159</span>, <span class="dv">791</span>, <span class="dv">1323</span>, <span class="dv">2046</span>, <span class="dv">52</span>,</span>
<span id="cb17-214"><a href="#cb17-214" aria-hidden="true" tabindex="-1"></a>  <span class="dv">666</span>, <span class="dv">496</span>, <span class="dv">1031</span>, <span class="dv">1632</span>, <span class="dv">646</span>, <span class="dv">474</span>, <span class="dv">129</span>, <span class="dv">87</span>, <span class="dv">124</span>, <span class="dv">11</span>,</span>
<span id="cb17-215"><a href="#cb17-215" aria-hidden="true" tabindex="-1"></a>  <span class="dv">300</span>, <span class="dv">218</span>, <span class="dv">171</span>, <span class="dv">220</span>, <span class="dv">8</span>, <span class="dv">438</span>, <span class="dv">254</span>, <span class="dv">669</span>, <span class="dv">703</span>, <span class="dv">16</span>,</span>
<span id="cb17-216"><a href="#cb17-216" aria-hidden="true" tabindex="-1"></a>  <span class="dv">601</span>, <span class="dv">388</span>, <span class="dv">932</span>, <span class="dv">1789</span>, <span class="dv">37</span>, <span class="dv">76</span>, <span class="dv">56</span>, <span class="dv">125</span>, <span class="dv">295</span>, <span class="dv">191</span>,</span>
<span id="cb17-217"><a href="#cb17-217" aria-hidden="true" tabindex="-1"></a>  <span class="dv">127</span>, <span class="dv">101</span>, <span class="dv">24</span>, <span class="dv">30</span>, <span class="dv">12</span>, <span class="dv">86</span>, <span class="dv">207</span>, <span class="dv">64</span>, <span class="dv">61</span>, <span class="dv">13</span>,</span>
<span id="cb17-218"><a href="#cb17-218" aria-hidden="true" tabindex="-1"></a>  <span class="dv">43</span>, <span class="dv">73</span>, <span class="dv">122</span>, <span class="dv">60</span>, <span class="dv">13</span>, <span class="dv">35</span>, <span class="dv">51</span>, <span class="dv">62</span>, <span class="dv">66</span>, <span class="dv">11</span>,</span>
<span id="cb17-219"><a href="#cb17-219" aria-hidden="true" tabindex="-1"></a>  <span class="dv">109</span>, <span class="dv">206</span>, <span class="dv">184</span>, <span class="dv">253</span>, <span class="dv">325</span>)</span>
<span id="cb17-220"><a href="#cb17-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-221"><a href="#cb17-221" aria-hidden="true" tabindex="-1"></a>d_xie <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb17-222"><a href="#cb17-222" aria-hidden="true" tabindex="-1"></a>  <span class="at">O =</span> <span class="fu">gl</span>(<span class="dv">5</span>, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">length =</span> <span class="dv">75</span>),</span>
<span id="cb17-223"><a href="#cb17-223" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> <span class="fu">gl</span>(<span class="dv">5</span>, <span class="at">k =</span> <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">75</span>),</span>
<span id="cb17-224"><a href="#cb17-224" aria-hidden="true" tabindex="-1"></a>  <span class="at">C =</span> <span class="fu">gl</span>(<span class="dv">3</span>, <span class="at">k =</span> <span class="dv">25</span>, <span class="at">length =</span> <span class="dv">75</span>),</span>
<span id="cb17-225"><a href="#cb17-225" aria-hidden="true" tabindex="-1"></a>  <span class="at">Freq =</span> Freq_yamaguchi</span>
<span id="cb17-226"><a href="#cb17-226" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb17-227"><a href="#cb17-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-228"><a href="#cb17-228" aria-hidden="true" tabindex="-1"></a>    <span class="at">Diag =</span> <span class="fu">case_when</span>(O <span class="sc">==</span> D <span class="sc">~</span> O, <span class="at">.default =</span> <span class="st">"0"</span>) <span class="sc">|&gt;</span> <span class="fu">factor</span>()</span>
<span id="cb17-229"><a href="#cb17-229" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-230"><a href="#cb17-230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-231"><a href="#cb17-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-232"><a href="#cb17-232" aria-hidden="true" tabindex="-1"></a><span class="fu">### gnmによる推定</span></span>
<span id="cb17-233"><a href="#cb17-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-236"><a href="#cb17-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-237"><a href="#cb17-237" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb17-238"><a href="#cb17-238" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb17-239"><a href="#cb17-239" aria-hidden="true" tabindex="-1"></a>fit_gnm <span class="ot">&lt;-</span> <span class="fu">gnm</span>(Freq <span class="sc">~</span> O<span class="sc">*</span>C <span class="sc">+</span> D<span class="sc">*</span>C <span class="sc">+</span> Diag<span class="sc">*</span>C <span class="sc">+</span> <span class="fu">Mult</span>(<span class="fu">Exp</span>(C), O<span class="sc">*</span>D),</span>
<span id="cb17-240"><a href="#cb17-240" aria-hidden="true" tabindex="-1"></a>               <span class="at">family =</span> poisson, <span class="at">data =</span> d_xie, <span class="at">tolerance =</span> <span class="fl">1e-12</span>)</span>
<span id="cb17-241"><a href="#cb17-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-242"><a href="#cb17-242" aria-hidden="true" tabindex="-1"></a><span class="co"># スケーリングパラメータの取り出し</span></span>
<span id="cb17-243"><a href="#cb17-243" aria-hidden="true" tabindex="-1"></a>coef_gnm <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_gnm)</span>
<span id="cb17-244"><a href="#cb17-244" aria-hidden="true" tabindex="-1"></a>exp_c_coefs <span class="ot">&lt;-</span> coef_gnm[<span class="fu">grep</span>(<span class="st">"^Mult.*Exp.*</span><span class="sc">\\</span><span class="st">.C"</span>, <span class="fu">names</span>(coef_gnm))]</span>
<span id="cb17-245"><a href="#cb17-245" aria-hidden="true" tabindex="-1"></a>gnm_beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(exp_c_coefs <span class="sc">-</span> exp_c_coefs[<span class="dv">1</span>])</span>
<span id="cb17-246"><a href="#cb17-246" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(gnm_beta) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"US"</span>, <span class="st">"Britain"</span>, <span class="st">"Japan"</span>)</span>
<span id="cb17-247"><a href="#cb17-247" aria-hidden="true" tabindex="-1"></a>gnm_beta</span>
<span id="cb17-248"><a href="#cb17-248" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       US  Britain    Japan</span></span>
<span id="cb17-249"><a href="#cb17-249" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   1.0000   1.0398   0.7991</span></span>
<span id="cb17-250"><a href="#cb17-250" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-251"><a href="#cb17-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-252"><a href="#cb17-252" aria-hidden="true" tabindex="-1"></a><span class="in">`Mult(Exp(C), O*D)`</span> がUnidiff項であり、<span class="in">`Diag*C`</span> は対角セルの飽和を表す。</span>
<span id="cb17-253"><a href="#cb17-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-254"><a href="#cb17-254" aria-hidden="true" tabindex="-1"></a><span class="fu">### Stanによる推定</span></span>
<span id="cb17-255"><a href="#cb17-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-256"><a href="#cb17-256" aria-hidden="true" tabindex="-1"></a>対角セルを完全飽和（<span class="in">`alpha_diag`</span>、15セル）させ、非対角セルにのみUnidiff構造（<span class="in">`beta[k] * psi[ij]`</span>）を適用する。</span>
<span id="cb17-257"><a href="#cb17-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-260"><a href="#cb17-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-261"><a href="#cb17-261" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb17-262"><a href="#cb17-262" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb17-263"><a href="#cb17-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-264"><a href="#cb17-264" aria-hidden="true" tabindex="-1"></a>stan_code <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb17-265"><a href="#cb17-265" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb17-266"><a href="#cb17-266" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N; int&lt;lower=1&gt; I; int&lt;lower=1&gt; J; int&lt;lower=1&gt; K;</span></span>
<span id="cb17-267"><a href="#cb17-267" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; IJ; int&lt;lower=1&gt; N_diag;</span></span>
<span id="cb17-268"><a href="#cb17-268" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1&gt; row_idx; array[N] int&lt;lower=1&gt; col_idx;</span></span>
<span id="cb17-269"><a href="#cb17-269" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1&gt; layer_idx; array[N] int&lt;lower=1&gt; cell_idx;</span></span>
<span id="cb17-270"><a href="#cb17-270" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0, upper=N_diag&gt; diag_cell_idx;</span></span>
<span id="cb17-271"><a href="#cb17-271" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0&gt; y;</span></span>
<span id="cb17-272"><a href="#cb17-272" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb17-273"><a href="#cb17-273" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb17-274"><a href="#cb17-274" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha;</span></span>
<span id="cb17-275"><a href="#cb17-275" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[I-1] alpha_row_raw; vector[J-1] alpha_col_raw;</span></span>
<span id="cb17-276"><a href="#cb17-276" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K-1] alpha_layer_raw;</span></span>
<span id="cb17-277"><a href="#cb17-277" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I-1, K-1] alpha_row_layer_raw;</span></span>
<span id="cb17-278"><a href="#cb17-278" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[J-1, K-1] alpha_col_layer_raw;</span></span>
<span id="cb17-279"><a href="#cb17-279" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_diag-1] alpha_diag_raw;</span></span>
<span id="cb17-280"><a href="#cb17-280" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[IJ-1] psi_raw;</span></span>
<span id="cb17-281"><a href="#cb17-281" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K-1] beta_raw;</span></span>
<span id="cb17-282"><a href="#cb17-282" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb17-283"><a href="#cb17-283" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb17-284"><a href="#cb17-284" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[I] alpha_row; vector[J] alpha_col; vector[K] alpha_layer;</span></span>
<span id="cb17-285"><a href="#cb17-285" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I, K] alpha_row_layer; matrix[J, K] alpha_col_layer;</span></span>
<span id="cb17-286"><a href="#cb17-286" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_diag] alpha_diag; vector[IJ] psi; vector[K] beta;</span></span>
<span id="cb17-287"><a href="#cb17-287" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] log_mu;</span></span>
<span id="cb17-288"><a href="#cb17-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-289"><a href="#cb17-289" aria-hidden="true" tabindex="-1"></a><span class="st">  // コーナー制約</span></span>
<span id="cb17-290"><a href="#cb17-290" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha_row[1]=0; alpha_col[1]=0; alpha_layer[1]=0;</span></span>
<span id="cb17-291"><a href="#cb17-291" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 2:I) alpha_row[i] = alpha_row_raw[i-1];</span></span>
<span id="cb17-292"><a href="#cb17-292" aria-hidden="true" tabindex="-1"></a><span class="st">  for(j in 2:J) alpha_col[j] = alpha_col_raw[j-1];</span></span>
<span id="cb17-293"><a href="#cb17-293" aria-hidden="true" tabindex="-1"></a><span class="st">  for(k in 2:K) alpha_layer[k] = alpha_layer_raw[k-1];</span></span>
<span id="cb17-294"><a href="#cb17-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-295"><a href="#cb17-295" aria-hidden="true" tabindex="-1"></a><span class="st">  // 交互作用</span></span>
<span id="cb17-296"><a href="#cb17-296" aria-hidden="true" tabindex="-1"></a><span class="st">  for(k in 1:K) { alpha_row_layer[1,k]=0; alpha_col_layer[1,k]=0; }</span></span>
<span id="cb17-297"><a href="#cb17-297" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:I) alpha_row_layer[i,1] = 0;</span></span>
<span id="cb17-298"><a href="#cb17-298" aria-hidden="true" tabindex="-1"></a><span class="st">  for(j in 1:J) alpha_col_layer[j,1] = 0;</span></span>
<span id="cb17-299"><a href="#cb17-299" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 2:I) for(k in 2:K)</span></span>
<span id="cb17-300"><a href="#cb17-300" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha_row_layer[i,k] = alpha_row_layer_raw[i-1,k-1];</span></span>
<span id="cb17-301"><a href="#cb17-301" aria-hidden="true" tabindex="-1"></a><span class="st">  for(j in 2:J) for(k in 2:K)</span></span>
<span id="cb17-302"><a href="#cb17-302" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha_col_layer[j,k] = alpha_col_layer_raw[j-1,k-1];</span></span>
<span id="cb17-303"><a href="#cb17-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-304"><a href="#cb17-304" aria-hidden="true" tabindex="-1"></a><span class="st">  // 対角セルの完全飽和（15セル, 14自由パラメータ）</span></span>
<span id="cb17-305"><a href="#cb17-305" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha_diag[1] = 0;</span></span>
<span id="cb17-306"><a href="#cb17-306" aria-hidden="true" tabindex="-1"></a><span class="st">  for(d in 2:N_diag) alpha_diag[d] = alpha_diag_raw[d-1];</span></span>
<span id="cb17-307"><a href="#cb17-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-308"><a href="#cb17-308" aria-hidden="true" tabindex="-1"></a><span class="st">  // OD連関パターン</span></span>
<span id="cb17-309"><a href="#cb17-309" aria-hidden="true" tabindex="-1"></a><span class="st">  psi[1] = 0;</span></span>
<span id="cb17-310"><a href="#cb17-310" aria-hidden="true" tabindex="-1"></a><span class="st">  for(ij in 2:IJ) psi[ij] = psi_raw[ij-1];</span></span>
<span id="cb17-311"><a href="#cb17-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-312"><a href="#cb17-312" aria-hidden="true" tabindex="-1"></a><span class="st">  // Unidiffスケーリング（beta[1]=1に固定）</span></span>
<span id="cb17-313"><a href="#cb17-313" aria-hidden="true" tabindex="-1"></a><span class="st">  beta[1] = 1;</span></span>
<span id="cb17-314"><a href="#cb17-314" aria-hidden="true" tabindex="-1"></a><span class="st">  for(k in 2:K) beta[k] = exp(beta_raw[k-1]);</span></span>
<span id="cb17-315"><a href="#cb17-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-316"><a href="#cb17-316" aria-hidden="true" tabindex="-1"></a><span class="st">  // 期待度数</span></span>
<span id="cb17-317"><a href="#cb17-317" aria-hidden="true" tabindex="-1"></a><span class="st">  for(n in 1:N) {</span></span>
<span id="cb17-318"><a href="#cb17-318" aria-hidden="true" tabindex="-1"></a><span class="st">    log_mu[n] = alpha + alpha_row[row_idx[n]] + alpha_col[col_idx[n]]</span></span>
<span id="cb17-319"><a href="#cb17-319" aria-hidden="true" tabindex="-1"></a><span class="st">                + alpha_layer[layer_idx[n]]</span></span>
<span id="cb17-320"><a href="#cb17-320" aria-hidden="true" tabindex="-1"></a><span class="st">                + alpha_row_layer[row_idx[n], layer_idx[n]]</span></span>
<span id="cb17-321"><a href="#cb17-321" aria-hidden="true" tabindex="-1"></a><span class="st">                + alpha_col_layer[col_idx[n], layer_idx[n]];</span></span>
<span id="cb17-322"><a href="#cb17-322" aria-hidden="true" tabindex="-1"></a><span class="st">    if(diag_cell_idx[n] &gt; 0)</span></span>
<span id="cb17-323"><a href="#cb17-323" aria-hidden="true" tabindex="-1"></a><span class="st">      log_mu[n] += alpha_diag[diag_cell_idx[n]];</span></span>
<span id="cb17-324"><a href="#cb17-324" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb17-325"><a href="#cb17-325" aria-hidden="true" tabindex="-1"></a><span class="st">      log_mu[n] += beta[layer_idx[n]] * psi[cell_idx[n]];</span></span>
<span id="cb17-326"><a href="#cb17-326" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb17-327"><a href="#cb17-327" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb17-328"><a href="#cb17-328" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb17-329"><a href="#cb17-329" aria-hidden="true" tabindex="-1"></a><span class="st">  y ~ poisson_log(log_mu);</span></span>
<span id="cb17-330"><a href="#cb17-330" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb17-331"><a href="#cb17-331" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb17-332"><a href="#cb17-332" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] expected;</span></span>
<span id="cb17-333"><a href="#cb17-333" aria-hidden="true" tabindex="-1"></a><span class="st">  for(n in 1:N) expected[n] = exp(log_mu[n]);</span></span>
<span id="cb17-334"><a href="#cb17-334" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb17-335"><a href="#cb17-335" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb17-336"><a href="#cb17-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-337"><a href="#cb17-337" aria-hidden="true" tabindex="-1"></a><span class="co"># データの準備</span></span>
<span id="cb17-338"><a href="#cb17-338" aria-hidden="true" tabindex="-1"></a>d_xie_stan <span class="ot">&lt;-</span> d_xie <span class="sc">|&gt;</span></span>
<span id="cb17-339"><a href="#cb17-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-340"><a href="#cb17-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">i_O =</span> <span class="fu">as.integer</span>(O), <span class="at">i_D =</span> <span class="fu">as.integer</span>(D), <span class="at">i_C =</span> <span class="fu">as.integer</span>(C),</span>
<span id="cb17-341"><a href="#cb17-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">cell_OD =</span> (i_O <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">5</span> <span class="sc">+</span> i_D,</span>
<span id="cb17-342"><a href="#cb17-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">diag_cell_idx =</span> <span class="fu">if_else</span>(O <span class="sc">==</span> D, (i_C <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">5</span> <span class="sc">+</span> <span class="fu">as.integer</span>(O), <span class="dv">0</span>L)</span>
<span id="cb17-343"><a href="#cb17-343" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-344"><a href="#cb17-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-345"><a href="#cb17-345" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb17-346"><a href="#cb17-346" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="dv">75</span>, <span class="at">I =</span> <span class="dv">5</span>, <span class="at">J =</span> <span class="dv">5</span>, <span class="at">K =</span> <span class="dv">3</span>, <span class="at">IJ =</span> <span class="dv">25</span>, <span class="at">N_diag =</span> <span class="dv">15</span>,</span>
<span id="cb17-347"><a href="#cb17-347" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_idx =</span> d_xie_stan<span class="sc">$</span>i_O, <span class="at">col_idx =</span> d_xie_stan<span class="sc">$</span>i_D,</span>
<span id="cb17-348"><a href="#cb17-348" aria-hidden="true" tabindex="-1"></a>  <span class="at">layer_idx =</span> d_xie_stan<span class="sc">$</span>i_C, <span class="at">cell_idx =</span> d_xie_stan<span class="sc">$</span>cell_OD,</span>
<span id="cb17-349"><a href="#cb17-349" aria-hidden="true" tabindex="-1"></a>  <span class="at">diag_cell_idx =</span> d_xie_stan<span class="sc">$</span>diag_cell_idx, <span class="at">y =</span> d_xie_stan<span class="sc">$</span>Freq</span>
<span id="cb17-350"><a href="#cb17-350" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-351"><a href="#cb17-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-352"><a href="#cb17-352" aria-hidden="true" tabindex="-1"></a><span class="co"># MLE推定</span></span>
<span id="cb17-353"><a href="#cb17-353" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="fu">write_stan_file</span>(stan_code))</span>
<span id="cb17-354"><a href="#cb17-354" aria-hidden="true" tabindex="-1"></a>fit_mle <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">optimize</span>(<span class="at">data =</span> stan_data, <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb17-355"><a href="#cb17-355" aria-hidden="true" tabindex="-1"></a>                          <span class="at">algorithm =</span> <span class="st">"lbfgs"</span>,</span>
<span id="cb17-356"><a href="#cb17-356" aria-hidden="true" tabindex="-1"></a>                          <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">tol_rel_grad =</span> <span class="fl">1e-12</span>)</span>
<span id="cb17-357"><a href="#cb17-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-358"><a href="#cb17-358" aria-hidden="true" tabindex="-1"></a><span class="co"># スケーリングパラメータ</span></span>
<span id="cb17-359"><a href="#cb17-359" aria-hidden="true" tabindex="-1"></a>mle_summary <span class="ot">&lt;-</span> fit_mle<span class="sc">$</span><span class="fu">summary</span>()</span>
<span id="cb17-360"><a href="#cb17-360" aria-hidden="true" tabindex="-1"></a>beta_stan <span class="ot">&lt;-</span> mle_summary <span class="sc">|&gt;</span></span>
<span id="cb17-361"><a href="#cb17-361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"^beta</span><span class="sc">\\</span><span class="st">["</span>, variable)) <span class="sc">|&gt;</span> <span class="fu">pull</span>(estimate)</span>
<span id="cb17-362"><a href="#cb17-362" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; US=1.0000, Britain=1.0399, Japan=0.7991</span></span>
<span id="cb17-363"><a href="#cb17-363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-364"><a href="#cb17-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-365"><a href="#cb17-365" aria-hidden="true" tabindex="-1"></a><span class="fu">### 結果の比較</span></span>
<span id="cb17-366"><a href="#cb17-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-367"><a href="#cb17-367" aria-hidden="true" tabindex="-1"></a>| 手法 | US | Britain | Japan | L² |</span>
<span id="cb17-368"><a href="#cb17-368" aria-hidden="true" tabindex="-1"></a>|------|-----|---------|-------|-----|</span>
<span id="cb17-369"><a href="#cb17-369" aria-hidden="true" tabindex="-1"></a>| gnm | 1.0000 | 1.0398 | 0.7991 | 30.94 |</span>
<span id="cb17-370"><a href="#cb17-370" aria-hidden="true" tabindex="-1"></a>| LEM | 1.0000 | 1.0398 | 0.7989 | 30.94 |</span>
<span id="cb17-371"><a href="#cb17-371" aria-hidden="true" tabindex="-1"></a>| Stan (MLE) | 1.0000 | 1.0399 | 0.7991 | 31.00 |</span>
<span id="cb17-372"><a href="#cb17-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-373"><a href="#cb17-373" aria-hidden="true" tabindex="-1"></a>3つの手法で結果がほぼ一致する。期待度数の相関は r = 1.0000 である。</span>
<span id="cb17-374"><a href="#cb17-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-375"><a href="#cb17-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-376"><a href="#cb17-376" aria-hidden="true" tabindex="-1"></a><span class="fu">## RからLEMを繰り返し実行する</span></span>
<span id="cb17-377"><a href="#cb17-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-378"><a href="#cb17-378" aria-hidden="true" tabindex="-1"></a>macOSではWineの実行完了後に「Close the log window?」というダイアログが表示され、手動で閉じるまでプロセスが終了しない。以下の関数は、LEMをバックグラウンドで起動し、出力ファイルの完成を待ってWineプロセスを自動終了させる。</span>
<span id="cb17-379"><a href="#cb17-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-382"><a href="#cb17-382" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-383"><a href="#cb17-383" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb17-384"><a href="#cb17-384" aria-hidden="true" tabindex="-1"></a>run_lem <span class="ot">&lt;-</span> <span class="cf">function</span>(inp_path, out_path, lem_exe, <span class="at">label =</span> <span class="st">""</span>) {</span>
<span id="cb17-385"><a href="#cb17-385" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(out_path)) <span class="fu">file.remove</span>(out_path)</span>
<span id="cb17-386"><a href="#cb17-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-387"><a href="#cb17-387" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">Sys.info</span>()[<span class="st">"sysname"</span>] <span class="sc">==</span> <span class="st">"Windows"</span>) {</span>
<span id="cb17-388"><a href="#cb17-388" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(<span class="fu">paste</span>(<span class="fu">shQuote</span>(lem_exe), <span class="fu">shQuote</span>(inp_path), <span class="fu">shQuote</span>(out_path)))</span>
<span id="cb17-389"><a href="#cb17-389" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb17-390"><a href="#cb17-390" aria-hidden="true" tabindex="-1"></a>    cmd <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"wine"</span>, <span class="fu">shQuote</span>(lem_exe), <span class="fu">shQuote</span>(inp_path), <span class="fu">shQuote</span>(out_path))</span>
<span id="cb17-391"><a href="#cb17-391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(<span class="fu">paste</span>(cmd, <span class="st">"2&gt;/dev/null &amp;"</span>))</span>
<span id="cb17-392"><a href="#cb17-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-393"><a href="#cb17-393" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">600</span>) {</span>
<span id="cb17-394"><a href="#cb17-394" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="dv">1</span>)</span>
<span id="cb17-395"><a href="#cb17-395" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(out_path) <span class="sc">&amp;&amp;</span> <span class="fu">file.size</span>(out_path) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb17-396"><a href="#cb17-396" aria-hidden="true" tabindex="-1"></a>        old_size <span class="ot">&lt;-</span> <span class="fu">file.size</span>(out_path)</span>
<span id="cb17-397"><a href="#cb17-397" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Sys.sleep</span>(<span class="dv">2</span>)</span>
<span id="cb17-398"><a href="#cb17-398" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">file.size</span>(out_path) <span class="sc">==</span> old_size) <span class="cf">break</span></span>
<span id="cb17-399"><a href="#cb17-399" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb17-400"><a href="#cb17-400" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-401"><a href="#cb17-401" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(<span class="st">"wineserver -k 2&gt;/dev/null"</span>)</span>
<span id="cb17-402"><a href="#cb17-402" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="dv">1</span>)</span>
<span id="cb17-403"><a href="#cb17-403" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-404"><a href="#cb17-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-405"><a href="#cb17-405" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(out_path) <span class="sc">&amp;&amp;</span> <span class="fu">file.size</span>(out_path) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb17-406"><a href="#cb17-406" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(label, <span class="st">" completed: "</span>, out_path)</span>
<span id="cb17-407"><a href="#cb17-407" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb17-408"><a href="#cb17-408" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(label, <span class="st">" may have failed"</span>)</span>
<span id="cb17-409"><a href="#cb17-409" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-410"><a href="#cb17-410" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-411"><a href="#cb17-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-412"><a href="#cb17-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-413"><a href="#cb17-413" aria-hidden="true" tabindex="-1"></a>仕組みは以下の通りである。</span>
<span id="cb17-414"><a href="#cb17-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-415"><a href="#cb17-415" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`&amp;`</span> によりWineをバックグラウンドで起動する。<span class="in">`shQuote()`</span> でパスの空白に対応している。</span>
<span id="cb17-416"><a href="#cb17-416" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>出力ファイルのサイズを1秒ごとに確認し、2秒間変化しなければ書き込み完了と判断する。</span>
<span id="cb17-417"><a href="#cb17-417" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span><span class="in">`wineserver -k`</span> でWineプロセスを一括終了し、ダイアログを自動的に閉じる。他のWineアプリケーションも終了するため注意が必要である。</span>
<span id="cb17-418"><a href="#cb17-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-419"><a href="#cb17-419" aria-hidden="true" tabindex="-1"></a><span class="fu">### 複数モデルの一括実行</span></span>
<span id="cb17-420"><a href="#cb17-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-421"><a href="#cb17-421" aria-hidden="true" tabindex="-1"></a>モデル式をリストとして定義し、ループで一時的な <span class="in">`.inp`</span> ファイルを生成して実行する。</span>
<span id="cb17-422"><a href="#cb17-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-425"><a href="#cb17-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-426"><a href="#cb17-426" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb17-427"><a href="#cb17-427" aria-hidden="true" tabindex="-1"></a>lem_exe <span class="ot">&lt;-</span> <span class="st">"path/to/LEM95.EXE"</span></span>
<span id="cb17-428"><a href="#cb17-428" aria-hidden="true" tabindex="-1"></a>lem_dir <span class="ot">&lt;-</span> <span class="st">"path/to/lem_directory"</span></span>
<span id="cb17-429"><a href="#cb17-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-430"><a href="#cb17-430" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb17-431"><a href="#cb17-431" aria-hidden="true" tabindex="-1"></a>  <span class="at">M1 =</span> <span class="st">"mod {AB AC}"</span>,</span>
<span id="cb17-432"><a href="#cb17-432" aria-hidden="true" tabindex="-1"></a>  <span class="at">M2 =</span> <span class="st">"mod {AB AC BC}"</span>,</span>
<span id="cb17-433"><a href="#cb17-433" aria-hidden="true" tabindex="-1"></a>  <span class="at">M3 =</span> <span class="st">"mod {AB AC spe(BC,1a,A,b)}"</span></span>
<span id="cb17-434"><a href="#cb17-434" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-435"><a href="#cb17-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-436"><a href="#cb17-436" aria-hidden="true" tabindex="-1"></a>header <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"man 3"</span>, <span class="st">"dim 3 5 5"</span>, <span class="st">"lab A B C"</span>)</span>
<span id="cb17-437"><a href="#cb17-437" aria-hidden="true" tabindex="-1"></a>footer <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"des [0 1 2]"</span>, <span class="st">"dat mydata.dat"</span>)</span>
<span id="cb17-438"><a href="#cb17-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-439"><a href="#cb17-439" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name <span class="cf">in</span> <span class="fu">names</span>(models)) {</span>
<span id="cb17-440"><a href="#cb17-440" aria-hidden="true" tabindex="-1"></a>  inp_lines <span class="ot">&lt;-</span> <span class="fu">c</span>(header, models[[name]], footer)</span>
<span id="cb17-441"><a href="#cb17-441" aria-hidden="true" tabindex="-1"></a>  inp_path  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(lem_dir, <span class="fu">paste0</span>(<span class="st">"temp_"</span>, name, <span class="st">".inp"</span>))</span>
<span id="cb17-442"><a href="#cb17-442" aria-hidden="true" tabindex="-1"></a>  out_path  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(lem_dir, <span class="fu">paste0</span>(name, <span class="st">".out"</span>))</span>
<span id="cb17-443"><a href="#cb17-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-444"><a href="#cb17-444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(inp_lines, inp_path)</span>
<span id="cb17-445"><a href="#cb17-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">run_lem</span>(inp_path, out_path, lem_exe, <span class="at">label =</span> name)</span>
<span id="cb17-446"><a href="#cb17-446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.remove</span>(inp_path)</span>
<span id="cb17-447"><a href="#cb17-447" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-448"><a href="#cb17-448" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-449"><a href="#cb17-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-450"><a href="#cb17-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-451"><a href="#cb17-451" aria-hidden="true" tabindex="-1"></a><span class="fu">## 実務上の使い分け</span></span>
<span id="cb17-452"><a href="#cb17-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-453"><a href="#cb17-453" aria-hidden="true" tabindex="-1"></a>| 状況 | 推奨ツール |</span>
<span id="cb17-454"><a href="#cb17-454" aria-hidden="true" tabindex="-1"></a>|------|-----------|</span>
<span id="cb17-455"><a href="#cb17-455" aria-hidden="true" tabindex="-1"></a>| Rで完結したい | gnm |</span>
<span id="cb17-456"><a href="#cb17-456" aria-hidden="true" tabindex="-1"></a>| gnmで推定できないモデル | LEM または Stan |</span>
<span id="cb17-457"><a href="#cb17-457" aria-hidden="true" tabindex="-1"></a>| 結果の検証 | 複数ツールで比較 |</span>
<span id="cb17-458"><a href="#cb17-458" aria-hidden="true" tabindex="-1"></a>| ベイズ推定が必要 | Stan |</span>
<span id="cb17-459"><a href="#cb17-459" aria-hidden="true" tabindex="-1"></a>| 潜在クラスモデル | LEM または Stan |</span>
<span id="cb17-460"><a href="#cb17-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-461"><a href="#cb17-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-462"><a href="#cb17-462" aria-hidden="true" tabindex="-1"></a><span class="fu">## 参考文献 {-}</span></span>
<span id="cb17-463"><a href="#cb17-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-464"><a href="#cb17-464" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Vermunt, J. K. (1997). *LEM: A general program for the analysis of categorical data*. Tilburg University.</span>
<span id="cb17-465"><a href="#cb17-465" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Vermunt氏のウェブサイト</span><span class="co">](https://jeroenvermunt.nl/)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>